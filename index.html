<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã‘Ã˜V Logger: November Challenge</title>
    
    <!-- PWA / APP-LIKE CONFIGURATION -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d0d0d">
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NOV Logger">
    <!-- End PWA / APP-LIKE CONFIGURATION -->

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for the "Wave of Difficulty" graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Custom CSS for a dark, minimalist, mobile-first theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #d1d5db; /* Light gray text */
            -webkit-tap-highlight-color: transparent; 
        }
        /* Custom styling for the slider track/thumb */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #a0a0a0; 
            border-radius: 4px;
            margin: 10px 0;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ef4444; /* Red accent for the thumb */
            cursor: pointer;
            margin-top: -8px; 
        }
        .corrupted-text {
            font-size: 1.25rem; 
            font-weight: 700; 
            line-height: 1.5;
            color: #ef4444;
            display: block; 
        }

        #app-container {
            max-width: 500px;
            min-height: 100vh;
            margin: 0 auto;
            padding-top: 80px; 
            padding-bottom: 80px; 
        }
        .fixed-element {
            max-width: 500px; 
            margin: 0 auto;
            left: 0;
            right: 0;
        }
        #fixed-header {
             padding-bottom: 1rem; 
        }

        /* Custom scrollbar styling for the log display area */
        .log-scroll-area::-webkit-scrollbar {
            width: 6px;
        }
        .log-scroll-area::-webkit-scrollbar-track {
            background: #1f2937; 
            border-radius: 10px;
        }
        .log-scroll-area::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 10px;
        }
        .log-scroll-area::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* --- Modal Slide Animation --- */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0.5; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0.5; }
        }
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0.5; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0.5; }
        }
        .slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        .slide-out-left { animation: slideOutLeft 0.3s ease-in forwards; }
        .slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        .slide-out-right { animation: slideOutRight 0.3s ease-in forwards; }

    </style>
</head>
<body class="selection:bg-red-700 selection:text-white">

    <div id="app-container" class="shadow-2xl">
        <!-- FIXED HEADER (Progress and Stage) -->
        <header id="fixed-header" class="fixed-element fixed top-0 z-10 p-4 border-b border-neutral-800 bg-neutral-900 shadow-lg">
            <div class="flex justify-between items-center text-center">
                <div class="text-left">
                    <div id="current-stage-display" class="corrupted-text text-xl font-bold text-red-500"></div>
                </div>
                <div class="flex-shrink-0 text-right">
                    <div id="average-difficulty" class="text-xl font-extrabold text-red-500"></div>
                    <div class="text-xs text-neutral-400">Avg. Wave</div>
                </div>
                <div class="flex-shrink-0 text-right">
                    <div id="progress-percent" class="text-3xl font-extrabold text-red-500">0%</div>
                    <div class="text-xs text-neutral-400">Completion</div>
                </div>
            </div>
            
            <!-- PROGRESS BAR -->
            <div id="progress-bar-container" class="absolute bottom-0 left-0 right-0 h-1 bg-neutral-700">
                <div id="progress-bar" class="h-full bg-red-500 transition-all duration-500" style="width: 0%;"></div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="content" class="p-4">
            <!-- Content will be injected here: Log, Graph, Calendar, Timeline, or Data -->
        </main>

        <!-- FIXED FOOTER (Navigation) -->
        <footer class="fixed-element fixed bottom-0 z-20 bg-neutral-900 border-t border-neutral-800 shadow-2xl">
            <div class="flex justify-around p-3">
                <button onclick="showView('log')" id="nav-log" class="p-2 text-red-500 rounded-lg transition-colors hover:bg-neutral-800 flex flex-col items-center text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen"><path d="M12 20h9"/><path d="M16.5 3.5l-4 4L14 9.5l4-4 2-2z"/><path d="M15 5l4 4"/><path d="M21 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"/></svg>
                    <span>Log</span>
                </button>
                <button onclick="showView('graph')" id="nav-graph" class="p-2 text-neutral-400 rounded-lg transition-colors hover:bg-neutral-800 flex flex-col items-center text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                    <span>Wave</span>
                </button>
                <button onclick="showView('calendar')" id="nav-calendar" class="p-2 text-neutral-400 rounded-lg transition-colors hover:bg-neutral-800 flex flex-col items-center text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                    <span>Calendar</span>
                </button>
                <!-- NEW TIMELINE BUTTON -->
                <button onclick="showView('timeline')" id="nav-timeline" class="p-2 text-neutral-400 rounded-lg transition-colors hover:bg-neutral-800 flex flex-col items-center text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scroll-text"><path d="M8 2h8a2 2 0 0 1 2 2v20l-5-5-5 5V4a2 2 0 0 1 2-2z"/><path d="M10 10h4"/><path d="M10 14h4"/></svg>
                    <span>Timeline</span>
                </button>
                <button onclick="showView('data')" id="nav-data" class="p-2 text-neutral-400 rounded-lg transition-colors hover:bg-neutral-800 flex flex-col items-center text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-download"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>
                    <span>Data</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- Modals for messages (Updated structure for navigation) -->
    <div id="modal-container" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="relative w-full max-w-sm sm:max-w-lg flex items-center justify-center">
            
            <!-- LEFT ARROW -->
            <button id="modal-nav-left" data-target-date="" onclick="navigateDay('left')" class="hidden absolute left-[-40px] z-50 p-2 rounded-full bg-neutral-900/50 text-white hover:bg-red-700 transition duration-150 active:scale-90 shadow-xl sm:left-[-60px]">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
            </button>

            <!-- Modal Content (The part that slides) -->
            <div id="modal-content-wrapper" class="w-full overflow-hidden">
                 <!-- Inner container holds the actual content and receives the animation class -->
                 <div id="modal-content-inner" class="bg-neutral-800 p-6 rounded-xl shadow-2xl w-full">
                    <!-- Default content structure for error messages -->
                    <h3 id="modal-title" class="text-xl font-bold mb-3 text-white"></h3>
                    <div id="modal-content-area" class="mb-4">
                        <p id="modal-message" class="text-neutral-300"></p> 
                    </div>
                    <div id="modal-actions" class="flex justify-end space-x-3">
                         <button onclick="hideModal()" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-150">Got It</button>
                    </div>
                 </div>
            </div>

            <!-- RIGHT ARROW -->
            <button id="modal-nav-right" data-target-date="" onclick="navigateDay('right')" class="hidden absolute right-[-40px] z-50 p-2 rounded-full bg-neutral-900/50 text-white hover:bg-red-700 transition duration-150 active:scale-90 shadow-xl sm:right-[-60px]">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
            </button>
            
        </div>
    </div>
    
    <!-- Gemini Analysis Result Modal -->
    <div id="gemini-modal-container" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="bg-neutral-800 p-6 rounded-xl shadow-2xl w-full max-w-lg border-l-4 border-purple-500">
            <h3 class="text-xl font-bold mb-3 text-purple-400">AI Insight âœ¨</h3>
            <div id="gemini-result-area" class="mb-4 text-neutral-300 max-h-80 overflow-y-auto log-scroll-area whitespace-pre-wrap"></div>
            <div class="flex justify-end">
                 <button onclick="document.getElementById('gemini-modal-container').classList.add('hidden')" class="bg-neutral-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-neutral-600 transition duration-150">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const STORAGE_KEY = 'nov_logger_logs';
        const SETTINGS_KEY = 'nov_logger_settings';
        
        const START_MONTH = 10; // November is month 10 (0-indexed: 0=Jan, 10=Nov)
        const START_DAY = 1;
        const END_DAY = 30; 
        const STAGE_DEFINITIONS = [
            { endDay: 6, name: "STAGE 1" },
            { endDay: 12, name: "SÌµTÌµAÌ¶GÌ¸EÌ´ Ì·2Ì´" },
            { endDay: 18, name: "SÌ¶Ì©Ì“TÌ¸ÌªÍAÌ¸ÌŸÍ‹GÌµÌ³ÌšEÌ¶ÌœÍŒ Ì¶Ì©Í3Ì´Ì¼Í" },
            { endDay: 24, name: "SÌ·Ì¤Ì“TÌ¶Í–Ì„ÍAÌ¶Ì§ÍˆÌ…ÌGÌ·Ì®ÌÌ…EÌµÌ²ÍšÌ” Ì¶Ì¡ÍÌŒÌ‹4Ì·Ì§Í‰Ì†Ì•" },
            { endDay: 29, name: "ÅžÌµÌ³Ì«Ì€ÌÌ¿TÌ´Ì¨Ì˜Ì–ÌˆÍŒAÌ´Ì¢Ì–Ì¥Ì“Ì€ÍGÌ·Í‰Ì¹Ì—Í‘Í‚ÍŠÈ†Ì¸Ì¼Í‘Í† Ì·ÌªÌ„ÌŠ5Ì·Ì¨Ì±Ì’ÌÍ" },
            { endDay: 31, name: "ÅšÌ¸Ì¢ÌŸÌŠÌšÍœÍ…TÌ¸ÌªÍ‰ÌªÌ”ÌˆÍ…AÌ´Ì¬ÌÌžÌ¾ÌGÌ·Ì˜Ì²Ì£Í‹Ì‰Ì‡EÌ´ÌªÍ— Ì·ÌŸÌ£Í‰Ì«ÌŠÌÍ—Í 6Ì·ÍŽÌ»Ì Ì”" } 
        ];
        
        // --- GEMINI CONFIGURATION ---
        const apiKey = ""; // API Key provided by environment
        const geminiModel = "gemini-2.5-flash-preview-09-2025";
        const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;

        let currentView = 'log';
        let chartInstance = null;
        let targetEditDate = null; 
        let pendingImportData = null; 
        let modalCurrentDate = null; 

        // --- UTILITIES ---

        const formatDate = (date) => {
            const y = date.getUTCFullYear();
            const m = String(date.getUTCMonth() + 1).padStart(2, '0');
            const d = String(date.getUTCDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
        
        const dateFromISO = (isoString) => {
            const parts = isoString.split('-');
            return new Date(Date.UTC(parts[0], parseInt(parts[1]) - 1, parts[2]));
        };

        const isDateWithinLoggingBounds = (dateString) => {
            const settings = loadSettings();
            
            // 1. Must be after Nov 1st
            const today = new Date();
            const currentYear = today.getUTCFullYear();
            const startDateString = `${currentYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(START_DAY).padStart(2, '0')}`;
            const endDateString = `${currentYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(END_DAY).padStart(2, '0')}`;

            if (dateString < startDateString) {
                return false;
            }
            
            // 2. Cannot be in the future
            const todayDateString = formatDate(today);
            if (dateString > todayDateString) {
                return false;
            }
            
            // 3. Check official end date limit
            if (!settings.continueChallenge) {
                return dateString <= endDateString; 
            }
            
            return true;
        };

        const getAdjacentDay = (dateString, offset) => {
            const adjacentDate = dateFromISO(dateString); 
            const currentDay = adjacentDate.getUTCDate();
            adjacentDate.setUTCDate(currentDay + offset); 
            const adjacentDateString = formatDate(adjacentDate);
            
            if (!isDateWithinLoggingBounds(adjacentDateString)) {
                return null;
            }
            
            return adjacentDateString;
        };

        const showModal = (title, message, actionsHtml = '') => {
             const innerContainer = document.getElementById('modal-content-inner');
             innerContainer.innerHTML = `
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-white"></h3>
                <div id="modal-content-area" class="mb-4"><p id="modal-message" class="text-neutral-300"></p></div>
                <div id="modal-actions" class="flex justify-end space-x-3"></div>
             `;
             document.getElementById('modal-nav-left').classList.add('hidden');
             document.getElementById('modal-nav-right').classList.add('hidden');
             modalCurrentDate = null; 
             document.getElementById('modal-title').innerText = title;
             document.getElementById('modal-message').innerHTML = message;
             document.getElementById('modal-actions').innerHTML = actionsHtml || 
                 `<button onclick="hideModal()" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-150">Got It</button>`;
             document.getElementById('modal-container').classList.remove('hidden');
        };

        const hideModal = () => {
            document.getElementById('modal-container').classList.add('hidden');
            document.getElementById('modal-content-inner').classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
        };
        
        const isValidLogEntry = (log) => {
            return (
                typeof log === 'object' &&
                typeof log.date === 'string' && 
                /^\d{4}-\d{2}-\d{2}$/.test(log.date) && 
                typeof log.difficulty === 'number' &&
                log.difficulty >= 1 && log.difficulty <= 10 &&
                typeof log.reflection_note === 'string' &&
                typeof log.timestamp === 'number' 
            );
        };

        // --- GEMINI API HANDLERS ---

        async function callGemini(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Sorry, I couldn't generate an analysis at this time. Please try again later.";
            }
        }

        async function generateChallengeReport() {
            const logs = loadLogs();
            if (logs.length === 0) {
                showModal("No Data", "Please log some days before generating a report.");
                return;
            }
            
            const logSummary = logs.map(l => `Date: ${l.date}, Diff: ${l.difficulty}, Note: ${l.reflection_note.substring(0, 50)}`).join('\n');
            
            const prompt = `Analyze these daily logs for a "November Challenge". 
            Identify trends in difficulty and consistency. Provide a short, motivating summary of progress and 1 specific advice for improvement.
            Keep it under 150 words. Use an encouraging tone.
            
            Logs:
            ${logSummary}`;

            const modal = document.getElementById('gemini-modal-container');
            const resultArea = document.getElementById('gemini-result-area');
            resultArea.innerHTML = '<div class="animate-pulse text-purple-300">Generating Challenge Report...</div>';
            modal.classList.remove('hidden');

            const analysis = await callGemini(prompt);
            resultArea.innerText = analysis;
        }

        async function analyzeDailyLog(dateString) {
            const logs = loadLogs();
            const log = logs.find(l => l.date === dateString);
            
            if (!log) return;

            const prompt = `Analyze this single daily log entry for a personal challenge.
            Date: ${log.date}
            Difficulty (1-10): ${log.difficulty}
            User Note: "${log.reflection_note}"
            
            Provide a brief, supportive reflection (2-3 sentences) acknowledging their effort based on the difficulty and their note. Be specific to the content.`;

            const modal = document.getElementById('gemini-modal-container');
            const resultArea = document.getElementById('gemini-result-area');
            resultArea.innerHTML = '<div class="animate-pulse text-purple-300">Analyzing Daily Entry...</div>';
            modal.classList.remove('hidden');

            const analysis = await callGemini(prompt);
            resultArea.innerText = analysis;
        }

        // --- DATA MANAGEMENT ---

        const loadLogs = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) { return []; }
        };

        const saveLogs = (logs) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            } catch (error) {
                showModal("Storage Error", "Could not save log data.");
            }
        };
        
        const loadSettings = () => {
            try {
                const data = localStorage.getItem(SETTINGS_KEY);
                return data ? JSON.parse(data) : { continueChallenge: false, challengeChecked: false };
            } catch (error) { return { continueChallenge: false, challengeChecked: false }; }
        };

        const saveSettings = (settings) => {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            } catch (error) { console.error(error); }
        };

        const updateHeader = (logs) => {
            const today = new Date();
            const todayDateString = formatDate(today);
            const todayDay = today.getUTCDate();
            const todayMonth = today.getUTCMonth();
            const todayYear = today.getUTCFullYear();
            
            const START_DATE_STRING = `${todayYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(START_DAY).padStart(2, '0')}`;
            const END_DATE_STRING = `${todayYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(END_DAY).padStart(2, '0')}`;

            let progress = 0;
            if (todayDateString >= START_DATE_STRING && todayDateString <= END_DATE_STRING) { 
                progress = Math.min(100, Math.floor(((todayDay) / END_DAY) * 100)); 
            } else if (todayDateString > END_DATE_STRING) { 
                progress = 100;
            }
            
            document.getElementById('progress-percent').innerText = `${progress}%`;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            let avgDifficulty = 'N/A';
            try {
                const validDifficulties = logs.map(log => log.difficulty).filter(d => typeof d === 'number');
                if (validDifficulties.length > 0) {
                    const sum = validDifficulties.reduce((acc, val) => acc + val, 0);
                    avgDifficulty = (sum / validDifficulties.length).toFixed(1);
                }
            } catch (e) { avgDifficulty = 'Err'; }
            
            document.getElementById('average-difficulty').innerText = avgDifficulty;

            let currentStageName = "STARTING";
            if (todayDateString < START_DATE_STRING) currentStageName = "PREP PHASE";
            else if (todayDateString <= END_DATE_STRING) {
                for (const stage of STAGE_DEFINITIONS) {
                    if (todayDay <= stage.endDay) {
                        currentStageName = stage.name;
                        break;
                    }
                }
            } else if (todayDateString > END_DATE_STRING) {
                 currentStageName = loadSettings().continueChallenge ? STAGE_DEFINITIONS[5].name : "CHALLENGE ENDED";
            }
            document.getElementById('current-stage-display').innerHTML = currentStageName;
        };
        
        // --- RENDERERS ---

        const renderLogView = () => {
            // [Logic identical to restored file]
            const todayDateString = formatDate(new Date());
            const activeDateString = targetEditDate || todayDateString;
            const isWithinBounds = isDateWithinLoggingBounds(activeDateString);
            const isFutureDate = activeDateString > todayDateString;
            const settings = loadSettings();
            
            // Recalculate start/end date strings based on current year for comparison
            const today = new Date();
            const currentYear = today.getUTCFullYear();
            const START_DATE_STRING = `${currentYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(START_DAY).padStart(2, '0')}`;
            const END_DATE_STRING = `${currentYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(END_DAY).padStart(2, '0')}`;

            let logFormHTML;
            if (!isWithinBounds) {
                 if (isFutureDate) {
                    logFormHTML = `<div class="p-6 bg-neutral-800 rounded-xl shadow-lg text-center mt-4"><h2 class="text-2xl font-bold text-red-400 mb-2">Future Date</h2><p class="text-neutral-300">Cannot edit future logs.</p><p class="text-sm text-neutral-400 mt-2">Log Date: ${activeDateString}</p></div>`;
                } else if (activeDateString < START_DATE_STRING) {
                     logFormHTML = `<div class="p-6 bg-neutral-800 rounded-xl shadow-lg text-center mt-4"><h2 class="text-2xl font-bold text-red-400 mb-2">Before Challenge</h2><p class="text-neutral-300">Challenge starts Nov 1st.</p></div>`;
                } else if (!settings.continueChallenge && activeDateString > END_DATE_STRING) {
                    logFormHTML = `<div class="p-6 bg-neutral-800 rounded-xl shadow-lg text-center mt-4"><h2 class="text-2xl font-bold text-red-400 mb-2">Challenge Concluded</h2><p class="text-neutral-300">Logging disabled.</p></div>`;
                }
            } else {
                const logs = loadLogs();
                const dayLog = logs.find(log => log.date === activeDateString);
                let difficultyValue = dayLog ? dayLog.difficulty : 5;
                let reflectionValue = dayLog ? dayLog.reflection_note : '';
                let buttonText = dayLog ? 'UPDATE LOG' : 'LOG DAY\'S WAVE';
                const isEditingPast = activeDateString !== todayDateString;
                
                logFormHTML = `
                    <div class="p-4 sm:p-6 bg-neutral-800 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-6">${isEditingPast ? 'Editing Log for' : 'Daily Log for'} ${activeDateString}</h2>
                        <div class="mb-8">
                            <label class="block text-sm font-medium mb-2 text-neutral-300">ðŸŒŠ Difficulty Rating (1-10)</label>
                            <div class="text-center mb-4"><h1 id="current-difficulty" class="text-6xl font-extrabold text-red-500">${difficultyValue}</h1></div>
                            <input type="range" id="difficulty-rating" min="1" max="10" value="${difficultyValue}" oninput="document.getElementById('current-difficulty').innerText = this.value" class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-a0a0a0"/>
                        </div>
                        <div class="mb-8">
                            <label class="block text-sm font-medium mb-2 text-neutral-300">ðŸ“š Quick Log / Textbook Submitted</label>
                            <textarea id="daily-reflection" rows="4" class="w-full p-3 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 focus:ring-red-500 focus:border-red-500">${reflectionValue}</textarea>
                        </div>
                        <button onclick="handleLogSubmission('${activeDateString}')" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700">${buttonText}</button>
                    </div>`;
            }
            document.getElementById('content').innerHTML = logFormHTML;
        };

        const renderGraphView = () => {
            targetEditDate = null; 
            const logs = loadLogs().filter(log => log.difficulty); 
            logs.sort((a, b) => dateFromISO(a.date) - dateFromISO(b.date)); 
            const dates = logs.map(log => log.date.substring(5)); 
            const difficulties = logs.map(log => log.difficulty);

            // Added AI Report Button
            const graphHTML = `
                <div class="p-4 bg-neutral-800 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4">Difficulty Wave Graph</h2>
                    <div class="relative h-64 sm:h-80"><canvas id="difficultyChart"></canvas></div>
                    <button onclick="generateChallengeReport()" class="mt-6 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 flex items-center justify-center gap-2">
                        <span>âœ¨ Generate AI Challenge Report</span>
                    </button>
                </div>
            `;
            document.getElementById('content').innerHTML = graphHTML;

            if (chartInstance) chartInstance.destroy();
            setTimeout(() => {
                const ctx = document.getElementById('difficultyChart');
                if (!ctx) return; 
                chartInstance = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Daily Difficulty', data: difficulties, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', tension: 0.4, borderWidth: 3, pointRadius: 5, pointBackgroundColor: '#ef4444', fill: true, 
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 10, ticks: { color: '#d1d5db' }, grid: { color: '#252525' } }, x: { ticks: { color: '#d1d5db' }, grid: { color: '#252525' } } }, plugins: { legend: { display: false } } }
                });
            }, 0);
        };

        const renderCalendarView = () => {
            // [Standard calendar rendering logic]
            targetEditDate = null; 
            const logs = loadLogs();
            const logsMap = new Map(logs.map(log => [log.date, log]));
            const today = new Date();
            const currentYear = today.getFullYear();
            // Display calendar for November (Start Month)
            const firstDayOfMonth = dateFromISO(`${currentYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(START_DAY).padStart(2, '0')}`).getUTCDay(); 

            let calendarDaysHTML = '';
            for (let i = 0; i < firstDayOfMonth; i++) calendarDaysHTML += '<div></div>';

            for (let day = START_DAY; day <= END_DAY; day++) {
                const linkDateString = `${currentYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayLog = logsMap.get(linkDateString);
                const difficulty = dayLog ? dayLog.difficulty : null;
                const colorStyle = difficulty ? `background-color: hsl(${120 - (difficulty * 10.8)}, 90%, 50%);` : 'background-color: #262626;';
                const noteContent = dayLog ? dayLog.reflection_note.replace(/'/g, "\\'") : 'No log recorded.';

                // NEW: Check if it's the current day
                const todayString = formatDate(new Date());
                const isToday = linkDateString === todayString;
                const ringClass = isToday ? 'ring-4 ring-red-500' : '';
                
                // NEW: Check log status for text color
                // If logged, set text to black for better contrast on colored bg
                // If not logged (dark bg), keep text white/gray
                const isLogged = !!dayLog;
                const textColor = isLogged ? 'text-black font-extrabold' : 'text-white font-bold';

                calendarDaysHTML += `
                    <div onclick="showDayDetails('${linkDateString}')" style="${colorStyle}" class="aspect-square flex flex-col justify-center items-center rounded-lg p-1 cursor-pointer shadow-lg hover:scale-105 transition-transform ${ringClass}">
                        <div class="text-lg ${textColor}">${day}</div>
                        <div class="text-xs ${textColor}">${difficulty || '-'}</div>
                    </div>
                `;
            }

            document.getElementById('content').innerHTML = `
                <div class="p-4 bg-neutral-800 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-6 text-center">November Calendar Wave</h2>
                    <div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold mb-3 text-neutral-400"><span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span></div>
                    <div class="grid grid-cols-7 gap-3">${calendarDaysHTML}</div>
                </div>
            `;
        };
        
        const renderTimelineView = () => {
             targetEditDate = null; 
             const logs = loadLogs();
             logs.sort((a, b) => dateFromISO(b.date) - dateFromISO(a.date)); 
             if (logs.length === 0) {
                 document.getElementById('content').innerHTML = `<div class="p-6 bg-neutral-800 rounded-xl text-center"><h2 class="text-2xl font-bold text-red-400">No Logs</h2></div>`;
                 return;
             }
             const timelineCards = logs.map(log => {
                 const diffColor = `hsl(${120 - (log.difficulty * 10.8)}, 90%, 50%)`;
                 const d = dateFromISO(log.date);
                 return `
                    <div class="relative pl-6 sm:pl-8 mb-4">
                        <div class="absolute left-0 top-0 h-full w-0.5 bg-neutral-700"></div>
                        <div class="absolute left-[-8px] top-1 w-4 h-4 rounded-full border-2 border-red-500 z-10" style="background-color: ${diffColor};"></div>
                        <div class="bg-neutral-800 p-4 rounded-xl shadow-xl hover:scale-[1.01] transition-transform">
                            <h3 class="text-xl font-extrabold text-red-400">Day ${d.getUTCDate()}</h3>
                            <p class="text-neutral-300 text-sm">${log.reflection_note}</p>
                            <button onclick="handleEditDay('${log.date}')" class="text-sm text-red-500 mt-2">Edit Log</button>
                        </div>
                    </div>`;
             }).join('');
             document.getElementById('content').innerHTML = `<div class="p-4 space-y-4">${timelineCards}</div>`;
        };

        const renderDataView = () => {
             const logs = loadLogs();
             // ESCAPE BACKTICKS AND DOLLAR SIGNS TO PREVENT TEMPLATE LITERAL BREAKAGE
             const jsonLogs = JSON.stringify(logs, null, 2).replace(/`/g, '\\`').replace(/\$/g, '\\$'); 
             
             document.getElementById('content').innerHTML = `
                <div class="space-y-6 p-4">
                    <div class="bg-neutral-800 p-4 rounded-xl">
                        <h2 class="text-xl font-bold text-white mb-2">Export Data</h2>
                        <textarea id="export-data" readonly class="w-full p-3 bg-neutral-900 text-xs font-mono rounded text-white h-32">${jsonLogs}</textarea>
                        <div class="flex gap-2 mt-2">
                             <button onclick="copyToClipboard('export-data')" class="flex-1 bg-red-600 text-white py-2 rounded font-bold">Copy JSON</button>
                             <button onclick="downloadJSON('nov_logs.json')" class="flex-1 bg-neutral-600 text-white py-2 rounded font-bold">Download File</button>
                        </div>
                    </div>
                    <div class="bg-neutral-800 p-4 rounded-xl">
                         <h2 class="text-xl font-bold text-white mb-2">Import Data</h2>
                         <textarea id="import-data" class="w-full p-3 bg-neutral-900 text-xs font-mono rounded text-white h-32" placeholder="Paste JSON here..."></textarea>
                         <button onclick="handleImportConfirmation()" class="w-full mt-2 bg-red-700 text-white py-2 rounded font-bold">Import & Overwrite</button>
                    </div>
                </div>
             `;
        };

        const showDayDetails = (dateString, animationDirection = null) => {
            // [Original showDayDetails logic]
            const logs = loadLogs();
            const dayLog = logs.find(log => log.date === dateString) || {};
            const prevDateString = getAdjacentDay(dateString, -1);
            const nextDateString = getAdjacentDay(dateString, 1);
            modalCurrentDate = dateString; 
            
            const difficultyDisplay = dayLog.difficulty !== undefined ? dayLog.difficulty : 'N/A';
            const noteContent = dayLog.reflection_note || 'No log recorded.';
            const d = dateFromISO(dateString);
            const readableDate = d.toLocaleDateString('en-US', { timeZone: 'UTC', month: 'long', day: 'numeric' });

            // AI Button added to content
            const aiButton = dayLog.difficulty ? 
                `<button onclick="analyzeDailyLog('${dateString}')" class="mt-2 w-full text-sm text-purple-400 hover:text-purple-300 border border-purple-500/30 rounded px-2 py-1 transition">âœ¨ AI Analyze Day</button>` : '';

            let contentHTML = `
                <div class="mb-4">
                    <p class="text-lg font-bold mb-1">${readableDate}</p>
                    <p class="mb-2">Difficulty: <span class="text-xl font-extrabold text-red-400">${difficultyDisplay}</span></p>
                    ${aiButton}
                </div>
                <div class="bg-neutral-900 p-3 rounded-lg border border-neutral-700 max-h-64 overflow-y-auto log-scroll-area">
                    <p class="text-neutral-300 whitespace-pre-wrap">${noteContent}</p>
                </div>
            `;

            // [Standard navigation/edit buttons reconstruction]
            const innerContainer = document.getElementById('modal-content-inner');
            innerContainer.innerHTML = `
                 <h3 id="modal-title" class="text-xl font-bold text-white">Log Summary</h3>
                 <div id="modal-content-area" class="mb-4">${contentHTML}</div>
                 <div id="modal-actions" class="flex space-x-3 mt-4">
                      <button onclick="handleEditDay('${dateString}')" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700">Edit</button>
                      <button onclick="hideModal()" class="flex-1 border border-neutral-600 text-neutral-300 py-2 rounded-lg">Close</button>
                 </div>
             `;

            // Update arrows [Logic maintained from previous version]
            const navLeft = document.getElementById('modal-nav-left');
            const navRight = document.getElementById('modal-nav-right');
            if (prevDateString) { navLeft.classList.remove('hidden'); navLeft.dataset.targetDate = prevDateString; } else { navLeft.classList.add('hidden'); }
            if (nextDateString) { navRight.classList.remove('hidden'); navRight.dataset.targetDate = nextDateString; } else { navRight.classList.add('hidden'); }
            
            document.getElementById('modal-container').classList.remove('hidden');
        };

        // [Standard handlers from previous version kept]
        const handleLogSubmission = (dateString) => {
            // ... [Standard submission logic]
            const difficulty = parseInt(document.getElementById('difficulty-rating').value);
            const note = document.getElementById('daily-reflection').value.trim();
            const logs = loadLogs();
            const newLog = { date: dateString, difficulty, reflection_note: note, timestamp: Date.now() };
            const idx = logs.findIndex(l => l.date === dateString);
            if (idx > -1) logs[idx] = newLog; else logs.push(newLog);
            saveLogs(logs);
            updateHeader(logs);
            
            const todayDateString = formatDate(new Date());
            if (dateString !== todayDateString) showView('timeline'); else renderLogView(); 
        };
        
        const handleEditDay = (date) => { targetEditDate = date; hideModal(); showView('log'); };
        const navigateDay = (dir) => {
             const btn = document.getElementById(`modal-nav-${dir}`);
             if(btn && btn.dataset.targetDate) showDayDetails(btn.dataset.targetDate);
        };

        const showView = (view) => {
            currentView = view;
            if (view === 'log') renderLogView();
            if (view === 'graph') renderGraphView();
            if (view === 'calendar') renderCalendarView();
            if (view === 'timeline') renderTimelineView();
            if (view === 'data') renderDataView();
            // Update footer nav classes
            document.querySelectorAll('footer button').forEach(b => b.classList.remove('text-red-500'));
            document.getElementById(`nav-${view}`).classList.add('text-red-500');
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            const logs = loadLogs();
            checkChallengeStatusAndInitialize(logs);
        };

        // Check if challenge has ended (Dec 1st+)
        const checkChallengeStatusAndInitialize = (logs) => {
            const settings = loadSettings();
            const todayDateString = formatDate(new Date());
            const today = new Date();
            const currentYear = today.getUTCFullYear();
            const END_DATE_STRING = `${currentYear}-${String(START_MONTH + 1).padStart(2, '0')}-${String(END_DAY).padStart(2, '0')}`;

            // Logic to check date > end date
            if (todayDateString > END_DATE_STRING && !settings.challengeChecked) {
                 showCongratulationsModal();
            }
            
            updateHeader(logs);
            renderLogView();
            showView('log', true);
        };
        
        const showCongratulationsModal = () => {
             showModal("Challenge Complete!", "The November challenge has officially ended. Do you want to continue logging?", 
             `<button onclick="handleChallengeChoice(true)" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">Continue</button>
              <button onclick="handleChallengeChoice(false)" class="flex-1 border border-red-500 text-red-400 py-2 rounded">End Now</button>`);
        };
        
        const handleChallengeChoice = (choice) => {
            const settings = loadSettings();
            settings.continueChallenge = choice;
            settings.challengeChecked = true;
            saveSettings(settings);
            hideModal();
            updateHeader(loadLogs());
            renderLogView(); // Re-render to update button text if needed
        };

        // --- DATA MANAGEMENT HANDLERS ---
        
        /**
         * Copies text from a given element ID to the clipboard.
         */
        const copyToClipboard = (elementId) => {
            const textarea = document.getElementById(elementId);
            textarea.select();
            textarea.setSelectionRange(0, 99999); 

            try {
                document.execCommand('copy');
                showModal("Copied!", "The JSON data has been copied to your clipboard.");
            } catch (err) {
                console.error('Copy failed:', err);
                showModal("Copy Failed", "Could not copy to clipboard. Please select the text manually.");
            }
        };

        /**
         * Triggers a file download for the current log data.
         */
        const downloadJSON = (fileName) => {
            const logs = loadLogs();
            const jsonLogs = JSON.stringify(logs, null, 2);
            
            const blob = new Blob([jsonLogs], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showModal("Download Started", `File <strong>${fileName}</strong> is downloading.`);
        };
        
        /**
         * Initiates the confirmation process for importing data.
         */
        const handleImportConfirmation = () => {
            const importDataArea = document.getElementById('import-data');
            const jsonString = importDataArea.value.trim();

            if (!jsonString) {
                showModal("Import Error", "Please paste the JSON data into the text box before importing.");
                return;
            }

            try {
                const logsToImport = JSON.parse(jsonString);
                
                if (!Array.isArray(logsToImport)) {
                    showModal("Invalid Format", "The pasted data must be a valid JSON Array (`[...]`).");
                    return;
                }
                
                const invalidLogs = logsToImport.filter(log => !isValidLogEntry(log));

                if (invalidLogs.length > 0 && logsToImport.length > 0) {
                     showModal("Validation Failed", "The data appears invalid. Check the format: it should be an array of objects with <code>date</code>, <code>difficulty</code>, <code>reflection_note</code>, and <code>timestamp</code> keys.");
                     return;
                }
                
                pendingImportData = logsToImport;

                const actionsHtml = `
                    <button onclick="hideModal()" class="flex-1 border border-neutral-600 text-neutral-300 py-2 rounded-lg font-semibold hover:bg-neutral-700 transition duration-150">Cancel</button>
                    <button onclick="finalizeImport()" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-150">Confirm Overwrite</button>
                `;
                
                showModal(
                    "Confirm Data Overwrite", 
                    `You are about to import ${logsToImport.length} log entries. This will **permanently overwrite** all current data in your browser.`,
                    actionsHtml
                );

            } catch (error) {
                showModal("JSON Parse Error", "The data you pasted is not valid JSON format. Please ensure it is correctly formatted.");
                console.error("Import JSON Parse Error:", error);
            }
        };
        
        /**
         * Finalizes the data import process after confirmation.
         */
        const finalizeImport = () => {
            if (pendingImportData) {
                saveLogs(pendingImportData);
                hideModal();
                updateHeader(pendingImportData);
                showView('calendar'); 
                showModal("Import Successful", `Successfully imported ${pendingImportData.length} entries! Your new logs are now displayed.`);
                pendingImportData = null;
            }
        };


        // Expose Globals
        window.handleLogSubmission = handleLogSubmission;
        window.showView = showView;
        window.hideModal = hideModal;
        window.showDayDetails = showDayDetails;
        window.handleEditDay = handleEditDay;
        window.navigateDay = navigateDay;
        window.generateChallengeReport = generateChallengeReport;
        window.analyzeDailyLog = analyzeDailyLog;
        window.copyToClipboard = copyToClipboard;
        window.downloadJSON = downloadJSON;
        window.handleImportConfirmation = handleImportConfirmation;
        window.finalizeImport = finalizeImport;
        window.handleChallengeChoice = handleChallengeChoice;
    </script>
</body>
</html>
